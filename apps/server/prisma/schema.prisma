// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  output     = "../src/infrastructure/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String          @id @default(uuid())
  telegramId    BigInt          @unique
  username      String?
  tonAddress    String?
  balance       Float           @default(1000.0)
  positions     Position[]
  transactions  Transaction[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

enum MarketStatus {
  PENDING
  OPEN
  RESOLVING
  CLOSED
}

enum Outcome {
  YES
  NO
}

model Market {
  id            String         @id @default(uuid())
  question      String
  description   String?
  imageUrl      String?

  qYes          Float          @default(100.0)
  qNo           Float          @default(100.0)
  liquidityB    Float          @default(150.0)

  status        MarketStatus   @default(OPEN)
  outcome       Outcome?
  
  resolvedAt    DateTime?
  resolvedBy    String?        // "AI" | "ADMIN"
  expiresAt     DateTime

  history       PriceHistory[]
  positions     Position[]
  transactions  Transaction[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Position {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  marketId  String
  market    Market   @relation(fields: [marketId], references: [id])
  
  sharesYes Float    @default(0)
  sharesNo  Float    @default(0)
  
  invested  Float    // Total cost spent
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, marketId])
}

model PriceHistory {
  id        Int      @id @default(autoincrement())
  marketId  String
  market    Market   @relation(fields: [marketId], references: [id])
  priceYes  Float
  timestamp DateTime @default(now())
}

enum TransactionType {
  BUY_YES
  BUY_NO
  SELL_YES
  SELL_NO
  DEPOSIT
  WITHDRAW
  WIN_PAYOUT
}

model Transaction {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  type        TransactionType
  amount      Float
  marketId    String?
  market      Market?         @relation(fields: [marketId], references: [id])
  price       Float?          // Цена при сделке
  shares      Float?          // Количество shares
  txHash      String?         @unique // TON transaction hash для idempotency депозитов
  createdAt   DateTime        @default(now())
}
